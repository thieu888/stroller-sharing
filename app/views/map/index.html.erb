<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="display-5 fw-bold text-primary mb-3">
        <i class="fas fa-map me-3"></i>Carte interactive
      </h1>
      <p class="lead text-muted">Visualisez toutes les stations et poussettes en temps réel</p>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card text-center border-0 shadow-sm">
        <div class="card-body">
          <i class="fas fa-map-marked-alt fa-2x text-primary mb-2"></i>
          <h4 class="fw-bold"><%= @stations.count %></h4>
          <p class="text-muted mb-0">Stations</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card text-center border-0 shadow-sm">
        <div class="card-body">
          <i class="fas fa-baby-carriage fa-2x text-success mb-2"></i>
          <h4 class="fw-bold"><%= @strollers.where(status: 'available').count %></h4>
          <p class="text-muted mb-0">Disponibles</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card text-center border-0 shadow-sm">
        <div class="card-body">
          <i class="fas fa-user fa-2x text-warning mb-2"></i>
          <h4 class="fw-bold"><%= @strollers.where(status: 'in_use').count %></h4>
          <p class="text-muted mb-0">En cours</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card text-center border-0 shadow-sm">
        <div class="card-body">
          <i class="fas fa-tools fa-2x text-danger mb-2"></i>
          <h4 class="fw-bold"><%= @strollers.where(status: ['maintenance', 'cleaning']).count %></h4>
          <p class="text-muted mb-0">Maintenance</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-9">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0 fw-bold">Carte en temps réel</h5>
          <div class="btn-group" role="group">
            <input type="checkbox" class="btn-check" id="show-stations" autocomplete="off" checked>
            <label class="btn btn-outline-primary" for="show-stations">
              <i class="fas fa-building me-1"></i>Stations
            </label>

            <input type="checkbox" class="btn-check" id="show-strollers" autocomplete="off" checked>
            <label class="btn btn-outline-success" for="show-strollers">
              <i class="fas fa-baby-carriage me-1"></i>Poussettes
            </label>
          </div>
        </div>
        <div class="card-body p-0">
          <div id="full-map" style="height: 600px;"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-3">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0 fw-bold">
            <i class="fas fa-filter me-2"></i>Filtres
          </h5>
        </div>
        <div class="card-body">
          <h6 class="fw-bold mb-3">Statut des poussettes</h6>
          <div class="form-check mb-2">
            <input class="form-check-input status-filter" type="checkbox" value="available" id="filter-available" checked>
            <label class="form-check-label" for="filter-available">
              <span class="badge bg-success me-2"></span>Disponibles
            </label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input status-filter" type="checkbox" value="in_use" id="filter-in-use" checked>
            <label class="form-check-label" for="filter-in-use">
              <span class="badge bg-warning me-2"></span>En cours
            </label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input status-filter" type="checkbox" value="maintenance" id="filter-maintenance" checked>
            <label class="form-check-label" for="filter-maintenance">
              <span class="badge bg-danger me-2"></span>Maintenance
            </label>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input status-filter" type="checkbox" value="cleaning" id="filter-cleaning" checked>
            <label class="form-check-label" for="filter-cleaning">
              <span class="badge bg-info me-2"></span>Nettoyage
            </label>
          </div>
          
          <hr>
          
          <h6 class="fw-bold mb-3">Niveau de batterie</h6>
          <div class="form-check mb-2">
            <input class="form-check-input battery-filter" type="checkbox" value="high" id="battery-high" checked>
            <label class="form-check-label" for="battery-high">
              <i class="fas fa-battery-full text-success me-2"></i>Élevé (>50%)
            </label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input battery-filter" type="checkbox" value="medium" id="battery-medium" checked>
            <label class="form-check-label" for="battery-medium">
              <i class="fas fa-battery-half text-warning me-2"></i>Moyen (20-50%)
            </label>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input battery-filter" type="checkbox" value="low" id="battery-low" checked>
            <label class="form-check-label" for="battery-low">
              <i class="fas fa-battery-quarter text-danger me-2"></i>Faible (<20%)
            </label>
          </div>

          <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
            <i class="fas fa-undo me-1"></i>Réinitialiser
          </button>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0 fw-bold">
            <i class="fas fa-info-circle me-2"></i>Légende
          </h5>
        </div>
        <div class="card-body">
          <h6 class="fw-bold mb-2">Stations</h6>
          <div class="d-flex align-items-center mb-2">
            <div class="station-marker me-2" style="background-color: #28a745; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-baby-carriage text-white" style="font-size: 10px;"></i>
            </div>
            <span class="text-sm">Bien approvisionnée</span>
          </div>
          <div class="d-flex align-items-center mb-2">
            <div class="station-marker me-2" style="background-color: #ffc107; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-baby-carriage text-white" style="font-size: 10px;"></i>
            </div>
            <span class="text-sm">Peu de poussettes</span>
          </div>
          <div class="d-flex align-items-center mb-3">
            <div class="station-marker me-2" style="background-color: #dc3545; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-baby-carriage text-white" style="font-size: 10px;"></i>
            </div>
            <span class="text-sm">Vide</span>
          </div>

          <h6 class="fw-bold mb-2">Poussettes</h6>
          <div class="d-flex align-items-center mb-2">
            <div class="stroller-marker me-2" style="background-color: #28a745; width: 15px; height: 15px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-baby-carriage text-white" style="font-size: 8px;"></i>
            </div>
            <span class="text-sm">Disponible</span>
          </div>
          <div class="d-flex align-items-center mb-2">
            <div class="stroller-marker me-2" style="background-color: #ffc107; width: 15px; height: 15px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-user text-white" style="font-size: 8px;"></i>
            </div>
            <span class="text-sm">En cours d'utilisation</span>
          </div>
          <div class="d-flex align-items-center mb-2">
            <div class="stroller-marker me-2" style="background-color: #dc3545; width: 15px; height: 15px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-wrench text-white" style="font-size: 8px;"></i>
            </div>
            <span class="text-sm">Maintenance</span>
          </div>
          <div class="d-flex align-items-center">
            <div class="stroller-marker me-2" style="background-color: #17a2b8; width: 15px; height: 15px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-broom text-white" style="font-size: 8px;"></i>
            </div>
            <span class="text-sm">Nettoyage</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let fullMap;
  let stationMarkers = [];
  let strollerMarkers = [];

  document.addEventListener('DOMContentLoaded', function() {
    // Initialiser la carte complète
    fullMap = new StrollerMap('full-map', {
      center: [48.8566, 2.3522], // Paris
      zoom: 12
    });
    
    // Ajouter le contrôle de localisation
    fullMap.addLocationControl();
    
    // Données depuis Rails
    const stationsData = <%= raw @stations_json %>;
    const strollersData = <%= raw @strollers_json %>;
    
    // Ajouter les stations
    stationsData.forEach(station => {
      const marker = fullMap.addStation(station);
      stationMarkers.push(marker);
    });
    
    // Ajouter les poussettes
    strollersData.forEach(stroller => {
      if (stroller.lat && stroller.lng) {
        const marker = fullMap.addStroller(stroller);
        marker.strollerData = stroller;
        strollerMarkers.push(marker);
      }
    });
    
    // Ajuster la vue pour inclure tous les marqueurs
    if (stationsData.length > 0 || strollersData.length > 0) {
      fullMap.fitBounds();
    }
    
    // Gestion des filtres
    setupFilters();
  });

  function setupFilters() {
    // Filtres de visibilité
    document.getElementById('show-stations').addEventListener('change', function() {
      stationMarkers.forEach(marker => {
        if (this.checked) {
          fullMap.map.addLayer(marker);
        } else {
          fullMap.map.removeLayer(marker);
        }
      });
    });

    document.getElementById('show-strollers').addEventListener('change', function() {
      strollerMarkers.forEach(marker => {
        if (this.checked) {
          fullMap.map.addLayer(marker);
        } else {
          fullMap.map.removeLayer(marker);
        }
      });
    });

    // Filtres de statut
    document.querySelectorAll('.status-filter').forEach(filter => {
      filter.addEventListener('change', applyStrollerFilters);
    });

    // Filtres de batterie
    document.querySelectorAll('.battery-filter').forEach(filter => {
      filter.addEventListener('change', applyStrollerFilters);
    });
  }

  function applyStrollerFilters() {
    const statusFilters = Array.from(document.querySelectorAll('.status-filter:checked')).map(cb => cb.value);
    const batteryFilters = Array.from(document.querySelectorAll('.battery-filter:checked')).map(cb => cb.value);
    
    strollerMarkers.forEach(marker => {
      const stroller = marker.strollerData;
      let showMarker = true;
      
      // Filtre de statut
      if (!statusFilters.includes(stroller.status)) {
        showMarker = false;
      }
      
      // Filtre de batterie
      if (stroller.battery_level !== null && stroller.battery_level !== undefined) {
        let batteryCategory = 'low';
        if (stroller.battery_level > 50) batteryCategory = 'high';
        else if (stroller.battery_level >= 20) batteryCategory = 'medium';
        
        if (!batteryFilters.includes(batteryCategory)) {
          showMarker = false;
        }
      }
      
      // Appliquer la visibilité
      if (showMarker && document.getElementById('show-strollers').checked) {
        fullMap.map.addLayer(marker);
      } else {
        fullMap.map.removeLayer(marker);
      }
    });
  }

  function resetFilters() {
    // Réinitialiser tous les filtres
    document.querySelectorAll('.status-filter, .battery-filter').forEach(cb => {
      cb.checked = true;
    });
    
    // Réappliquer les filtres
    applyStrollerFilters();
  }
</script>
