<div class="container py-4">
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="display-5 fw-bold text-primary mb-3">
        <i class="fas fa-route me-3"></i>Mes trajets
      </h1>
      <p class="lead text-muted">Gérez vos trajets en cours et consultez votre historique</p>
    </div>
  </div>

  <!-- Trajet en cours -->
  <% if @current_ride %>
    <div class="row mb-4">
      <div class="col-12">
        <div class="alert alert-warning border-0 shadow-sm" role="alert">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="alert-heading mb-2">
                <i class="fas fa-play-circle me-2"></i>Trajet en cours
              </h5>
              <p class="mb-2">
                <strong>Poussette:</strong> <%= @current_ride.stroller.qr_code %><br>
                <strong>Démarré:</strong> <%= l(@current_ride.start_time, format: :short) %><br>
                <strong>Durée:</strong> <span id="duration-counter" data-start="<%= @current_ride.start_time.to_i %>"></span>
              </p>
            </div>
            <div>
              <%= link_to "Voir détails", ride_path(@current_ride), class: "btn btn-outline-warning me-2" %>
              <%= link_to "Terminer", end_ride_ride_path(@current_ride), 
                  method: :patch, 
                  class: "btn btn-danger",
                  data: { 
                    confirm: "Êtes-vous sûr de vouloir terminer ce trajet ?",
                    turbo_method: :patch
                  } %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Statistiques -->
  <div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card text-center border-0 shadow-sm">
        <div class="card-body">
          <i class="fas fa-route fa-2x text-primary mb-2"></i>
          <h4 class="fw-bold"><%= @total_rides %></h4>
          <p class="text-muted mb-0">Trajets effectués</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card text-center border-0 shadow-sm">
        <div class="card-body">
          <i class="fas fa-euro-sign fa-2x text-success mb-2"></i>
          <h4 class="fw-bold"><%= number_to_currency(@total_cost, unit: "€") %></h4>
          <p class="text-muted mb-0">Total dépensé</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card text-center border-0 shadow-sm">
        <div class="card-body">
          <i class="fas fa-clock fa-2x text-info mb-2"></i>
          <h4 class="fw-bold">
            <% if @recent_rides.any? %>
              <%= time_ago_in_words(@recent_rides.first.created_at) %>
            <% else %>
              N/A
            <% end %>
          </h4>
          <p class="text-muted mb-0">Dernier trajet</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card text-center border-0 shadow-sm">
        <div class="card-body">
          <i class="fas fa-star fa-2x text-warning mb-2"></i>
          <h4 class="fw-bold">
            <%= @total_rides > 0 ? number_with_precision(@total_cost / @total_rides, precision: 2) : 0 %>€
          </h4>
          <p class="text-muted mb-0">Coût moyen</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Actions rapides -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="fw-bold mb-3">
            <i class="fas fa-bolt me-2"></i>Actions rapides
          </h5>
          <div class="row">
            <div class="col-md-4 mb-3">
              <%= link_to stations_path, class: "card text-decoration-none border-1 h-100" do %>
                <div class="card-body text-center">
                  <i class="fas fa-map-marked-alt fa-2x text-primary mb-2"></i>
                  <h6 class="fw-bold">Trouver une station</h6>
                  <p class="text-muted mb-0">Localisez la station la plus proche</p>
                </div>
              <% end %>
            </div>
            <div class="col-md-4 mb-3">
              <%= link_to strollers_path, class: "card text-decoration-none border-1 h-100" do %>
                <div class="card-body text-center">
                  <i class="fas fa-baby-carriage fa-2x text-success mb-2"></i>
                  <h6 class="fw-bold">Voir les poussettes</h6>
                  <p class="text-muted mb-0">Consultez toutes les poussettes disponibles</p>
                </div>
              <% end %>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card border-1 h-100">
                <div class="card-body text-center">
                  <i class="fas fa-qrcode fa-2x text-info mb-2"></i>
                  <h6 class="fw-bold">Scanner QR Code</h6>
                  <p class="text-muted mb-2">Scannez pour démarrer rapidement</p>
                  <button class="btn btn-sm btn-outline-info" disabled>
                    Bientôt disponible
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Historique des trajets -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0 fw-bold">
            <i class="fas fa-history me-2"></i>Historique des trajets
          </h5>
          <span class="badge bg-primary"><%= @recent_rides.count %> trajets</span>
        </div>
        <div class="card-body">
          <% if @recent_rides.any? %>
            <div class="list-group list-group-flush">
              <% @recent_rides.each do |ride| %>
                <div class="list-group-item border-0 px-0 py-3">
                  <div class="row align-items-center">
                    <div class="col-md-2 text-center mb-2 mb-md-0">
                      <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-light p-3">
                        <i class="fas fa-baby-carriage fa-lg text-primary"></i>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <h6 class="mb-1 fw-bold">
                        Poussette <%= ride.stroller.qr_code %>
                      </h6>
                      <p class="mb-1 text-muted">
                        <i class="fas fa-calendar me-1"></i>
                        <%= l(ride.created_at, format: :long) %>
                      </p>
                      <% if ride.start_time && ride.end_time %>
                        <small class="text-muted">
                          <i class="fas fa-clock me-1"></i>
                          Durée: <%= distance_of_time_in_words(ride.start_time, ride.end_time) %>
                        </small>
                      <% elsif ride.start_time %>
                        <small class="text-warning">
                          <i class="fas fa-play me-1"></i>
                          En cours depuis <%= distance_of_time_in_words(ride.start_time, Time.current) %>
                        </small>
                      <% end %>
                    </div>
                    <div class="col-md-2 text-center">
                      <span class="badge fs-6 
                        <%= case ride.status
                            when 'completed' then 'bg-success'
                            when 'in_progress' then 'bg-warning text-dark'
                            when 'cancelled' then 'bg-danger'
                            else 'bg-secondary'
                            end %>">
                        <%= ride.status&.humanize || 'En cours' %>
                      </span>
                    </div>
                    <div class="col-md-2 text-end">
                      <% if ride.cost %>
                        <h6 class="mb-1 fw-bold text-success">
                          <%= number_to_currency(ride.cost, unit: "€") %>
                        </h6>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                      <%= link_to "Détails", ride_path(ride), class: "btn btn-sm btn-outline-primary" %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>

            <% if @recent_rides.count >= 10 %>
              <div class="text-center mt-3">
                <button class="btn btn-outline-primary" disabled>
                  <i class="fas fa-plus me-1"></i>Charger plus de trajets
                </button>
                <p class="text-muted mt-2 mb-0">Fonctionnalité à venir</p>
              </div>
            <% end %>
          <% else %>
            <div class="text-center py-5">
              <i class="fas fa-route fa-4x text-muted mb-3"></i>
              <h5 class="text-muted">Aucun trajet pour le moment</h5>
              <p class="text-muted mb-3">Commencez votre premier trajet en trouvant une poussette disponible.</p>
              <%= link_to "Trouver une poussette", stations_path, class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<% if @current_ride %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const durationCounter = document.getElementById('duration-counter');
      if (durationCounter) {
        const startTime = parseInt(durationCounter.getAttribute('data-start')) * 1000;
        
        function updateDuration() {
          const now = new Date().getTime();
          const duration = now - startTime;
          
          const hours = Math.floor(duration / (1000 * 60 * 60));
          const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((duration % (1000 * 60)) / 1000);
          
          let durationText = '';
          if (hours > 0) {
            durationText = `${hours}h ${minutes}m ${seconds}s`;
          } else if (minutes > 0) {
            durationText = `${minutes}m ${seconds}s`;
          } else {
            durationText = `${seconds}s`;
          }
          
          durationCounter.textContent = durationText;
        }
        
        updateDuration();
        setInterval(updateDuration, 1000);
      }
    });
  </script>
<% end %>
